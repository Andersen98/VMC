#INFO: **** input file is /projects/anma2640/VMC/dqmc/VMC/examples/DQMC/h4_631g_act/h4.py ****
import numpy
import h5py
import scipy.sparse
from pyscf import gto, scf, mcscf, fci, ao2mo, lib, tools
from pauxy.utils.from_pyscf import generate_integrals
import prepVMC

r = 4.
atomstring = ""
for i in range(4):
  atomstring += "H 0 0 %g\n"%(i*r)
mol = gto.M(
    atom=atomstring,
    basis='6-31g',
    verbose=4,
    unit='Bohr',
    symmetry=0,
    spin=0)
mf = scf.RHF(mol)
mf.kernel()

# set up active space vmc
nact = 4
mo = mf.mo_coeff.copy()
lmo = prepVMC.localizeValence(mf, mo[:,:nact], "ibo")
mo[:,:nact] = lmo

overlap = mf.get_ovlp(mol)
rhfCoeffs = prepVMC.basisChange(mf.mo_coeff, mo, overlap)
prepVMC.writeMat(rhfCoeffs[:nact, :nact], "hf.txt")

h1 = lmo.T.dot(mf.get_hcore()).dot(lmo)
eri = ao2mo.kernel(mol, lmo)
print(f'eri.shape: {eri.shape}')
tools.fcidump.from_integrals('FCIDUMP_eri', h1, eri, nact, mol.nelectron, mf.energy_nuc())

# set up full space dqmc
prepVMC.writeMat(rhfCoeffs, "rhf.txt")
h1e, chol, nelec, enuc = generate_integrals(mol, mf.get_hcore(), mo, chol_cut=1e-5, verbose=True)
nbasis = h1e.shape[-1]
print(f'nelec: {nelec}')
print(f'nbasis: {nbasis}')
print(f'enuc: {enuc}')
print(f'chol.shape: {chol.shape}')
chol = chol.reshape((-1, nbasis, nbasis))
v0 = 0.5 * numpy.einsum('nik,njk->ij', chol, chol, optimize='optimal')
h1e_mod = h1e - v0

chol = chol.reshape((chol.shape[0], -1))
prepVMC.write_dqmc(h1e, h1e_mod, chol, mol.nelectron, mol.nao, enuc)

# fci
cisolver = fci.direct_spin1.FCI(mol)
h1 = mo.T.dot(mf.get_hcore()).dot(mo)
eri = ao2mo.kernel(mol, mo)
e, ci = cisolver.kernel(h1, eri, h1.shape[1], mol.nelec, ecore=mol.energy_nuc())
print(f"fci energy: {e}")
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bhpc-c7-u7-1.rc.int.colorado.edu', release='3.10.0-957.21.3.el7.x86_64', version='#1 SMP Tue Jun 18 16:35:19 UTC 2019', machine='x86_64', processor='x86_64')  Threads 36
Python 3.8.3 (default, May 19 2020, 18:47:26) 
[GCC 7.3.0]
numpy 1.19.1  scipy 1.5.2
Date: Tue Dec 29 15:34:54 2020
PySCF version 1.7.4
PySCF path  /projects/anma2640/pyscf/pyscf
GIT HEAD      ref: refs/heads/master
GIT master branch  14142ec394cbdcffb8e214fba6b1d6cde9025e9a

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 4
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry 0 subgroup None
[INPUT] Mole.unit = Bohr
[INPUT]  1 H      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 H      0.000000000000   0.000000000000   2.116708843680 AA    0.000000000000   0.000000000000   4.000000000000 Bohr
[INPUT]  3 H      0.000000000000   0.000000000000   4.233417687360 AA    0.000000000000   0.000000000000   8.000000000000 Bohr
[INPUT]  4 H      0.000000000000   0.000000000000   6.350126531040 AA    0.000000000000   0.000000000000  12.000000000000 Bohr

nuclear repulsion = 1.08333333333333
number of shells = 8
number of NR pGTOs = 16
number of NR cGTOs = 8
basis = 6-31g
ecp = {}
CPU time:         0.71


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /rc_scratch/anma2640/tmpm9l98o5o
max_memory 4000 MB (current use 78 MB)
Set gradient conv threshold to 3.16228e-05
init E= -1.30404423370612
  HOMO = -0.217083750247484  LUMO = -0.134989202551018
cycle= 1 E= -1.80017852822586  delta_E= -0.496  |g|= 0.0539  |ddm|= 1.17
  HOMO = -0.333806129308287  LUMO = -0.0885588211543946
cycle= 2 E= -1.8048580583712  delta_E= -0.00468  |g|= 0.0225  |ddm|= 0.141
  HOMO = -0.344277900027573  LUMO = -0.0809339081756547
cycle= 3 E= -1.80627699828353  delta_E= -0.00142  |g|= 0.00433  |ddm|= 0.116
  HOMO = -0.344120142352899  LUMO = -0.0801037038892071
cycle= 4 E= -1.8063013299749  delta_E= -2.43e-05  |g|= 0.00119  |ddm|= 0.0145
  HOMO = -0.344057140101574  LUMO = -0.0797699264243246
cycle= 5 E= -1.80630294046859  delta_E= -1.61e-06  |g|= 4.76e-05  |ddm|= 0.00279
  HOMO = -0.344106763559149  LUMO = -0.0797451727948397
cycle= 6 E= -1.80630294188417  delta_E= -1.42e-09  |g|= 4.06e-06  |ddm|= 0.000107
  HOMO = -0.344101976687643  LUMO = -0.0797492010989037
cycle= 7 E= -1.80630294190587  delta_E= -2.17e-11  |g|= 3.79e-07  |ddm|= 1.61e-05
  HOMO = -0.34410246155903  LUMO = -0.0797489407686967
Extra cycle  E= -1.80630294190613  delta_E= -2.54e-13  |g|= 1.66e-07  |ddm|= 1.01e-06
converged SCF energy = -1.80630294190613
 Iterative localization: IB/P4/2x2, 5 iter; Final gradient 6.90e-11
eri.shape: (10, 10)
 # Transforming hcore and eri to ortho AO basis.
 # Performing modified Cholesky decomposition on ERI tensor.
# Generating Cholesky decomposition of ERIs.
# max number of cholesky vectors = 80
# iteration     0: delta_max = 1.076566
# iteration     1: delta_max = 1.07011556e+00: time = 2.41927803e-04
# iteration     2: delta_max = 1.00808120e+00: time = 2.60571018e-04
# iteration     3: delta_max = 9.69487214e-01: time = 2.25139782e-04
# iteration     4: delta_max = 1.18777829e-01: time = 2.27354467e-04
# iteration     5: delta_max = 1.18046933e-01: time = 2.19369307e-04
# iteration     6: delta_max = 8.99444695e-02: time = 2.15712935e-04
# iteration     7: delta_max = 7.68697917e-02: time = 2.15344131e-04
# iteration     8: delta_max = 3.78815069e-03: time = 2.21064314e-04
# iteration     9: delta_max = 3.68406456e-03: time = 2.16396526e-04
# iteration    10: delta_max = 2.64784706e-03: time = 2.14301050e-04
# iteration    11: delta_max = 2.64703644e-03: time = 2.17121094e-04
# iteration    12: delta_max = 2.28560397e-03: time = 2.15783715e-04
# iteration    13: delta_max = 2.22582158e-03: time = 2.78294086e-04
# iteration    14: delta_max = 1.48387591e-03: time = 2.61053443e-04
# iteration    15: delta_max = 1.96573366e-04: time = 2.34009698e-04
# iteration    16: delta_max = 1.94273250e-04: time = 2.25408003e-04
# iteration    17: delta_max = 1.51132639e-04: time = 2.77101994e-04
# iteration    18: delta_max = 1.51044765e-04: time = 2.47856602e-04
# iteration    19: delta_max = 7.40050170e-05: time = 2.50115991e-04
# iteration    20: delta_max = 6.96819000e-05: time = 2.56678089e-04
# iteration    21: delta_max = 9.36429430e-07: time = 2.53139064e-04
 # Orthogonalising Cholesky vectors.
 # Time to orthogonalise: 0.000130
nelec: (2, 2)
nbasis: 8
enuc: 1.0833333333333333
chol.shape: (21, 64)
fci energy: -2.01953342363276
