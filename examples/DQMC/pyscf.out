#INFO: **** input file is /projects/anma2640/VMC/test/VMC/examples/DQMC/h2o/h2o.py ****
import numpy
from pyscf import gto, scf, mcscf, fci, ao2mo, lib, tools, cc
from pauxy.utils.from_pyscf import generate_integrals
import prepVMC

r = 0.9578
theta = 104.5078 * numpy.pi / 180.
atomstring = f'O 0. 0. 0.; H {r * numpy.sin(theta/2)}  {r * numpy.cos(theta/2)} 0.; H {-r * numpy.sin(theta/2)}  {r * numpy.cos(theta/2)} 0.'
mol = gto.M(
    atom=atomstring,
    basis='ccpvdz',
    verbose=4,
    unit='angstrom',
    symmetry=0,
    spin=0)
mf = scf.RHF(mol)
mf.kernel()
norb = mol.nao

# integrals in the canonical orbital basis
h1 = mf.mo_coeff.T.dot(mf.get_hcore()).dot(mf.mo_coeff)
eri = ao2mo.kernel(mol, mf.mo_coeff)
tools.fcidump.from_integrals('FCIDUMP_can', h1, eri, mol.nao, mol.nelectron, mf.energy_nuc())

# set up dqmc calculation
rhfCoeffs = numpy.eye(norb)
prepVMC.writeMat(rhfCoeffs, "rhf.txt")

# cholesky integrals using this funtion in pauxy
h1e, chol, nelec, enuc = generate_integrals(mol, mf.get_hcore(), mf.mo_coeff, chol_cut=1e-5, verbose=True)

nbasis = h1e.shape[-1]
print(f'nelec: {nelec}')
print(f'nbasis: {nbasis}')
print(f'chol.shape: {chol.shape}')
chol = chol.reshape((-1, nbasis, nbasis))
v0 = 0.5 * numpy.einsum('nik,njk->ij', chol, chol, optimize='optimal')
h1e_mod = h1e - v0
chol = chol.reshape((chol.shape[0], -1))
prepVMC.write_dqmc(h1e, h1e_mod, chol, sum(mol.nelec), nbasis, enuc, filename='FCIDUMP_chol')

# ccsd
mycc = cc.CCSD(mf)
mycc.frozen = 0
mycc.verbose = 5
mycc.kernel()
prepVMC.write_ccsd(mycc.t1, mycc.t2)

et = mycc.ccsd_t()
print('CCSD(T) energy', mycc.e_tot + et)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='shas0136', release='3.10.0-957.21.3.el7.x86_64', version='#1 SMP Fri Jun 14 02:54:29 EDT 2019', machine='x86_64', processor='x86_64')  Threads 1
Python 3.8.3 (default, May 19 2020, 18:47:26) 
[GCC 7.3.0]
numpy 1.19.1  scipy 1.5.2
Date: Tue Apr 20 11:11:22 2021
PySCF version 1.7.4
PySCF path  /projects/anma2640/pyscf/pyscf
GIT HEAD      ref: refs/heads/master
GIT master branch  14142ec394cbdcffb8e214fba6b1d6cde9025e9a

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 3
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry 0 subgroup None
[INPUT] Mole.unit = angstrom
[INPUT]  1 O      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 H      0.757362385714   0.586330160153   0.000000000000 AA    1.431207486047   1.108003421262   0.000000000000 Bohr
[INPUT]  3 H     -0.757362385714   0.586330160153   0.000000000000 AA   -1.431207486047   1.108003421262   0.000000000000 Bohr

nuclear repulsion = 9.18923359173398
number of shells = 11
number of NR pGTOs = 40
number of NR cGTOs = 24
basis = ccpvdz
ecp = {}
CPU time:         0.76


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /scratch/summit/anma2640/tmp4orq2ojq
max_memory 4000 MB (current use 80 MB)
Set gradient conv threshold to 3.16228e-05
init E= -75.856668664155
  HOMO = -0.476851568063705  LUMO = 0.100648758467842
cycle= 1 E= -75.9878409958453  delta_E= -0.131  |g|= 0.448  |ddm|= 1.31
  HOMO = -0.41263533586788  LUMO = 0.18654894433864
cycle= 2 E= -76.017726164869  delta_E= -0.0299  |g|= 0.228  |ddm|= 0.37
  HOMO = -0.500096147195492  LUMO = 0.180739104534961
cycle= 3 E= -76.0265613137287  delta_E= -0.00884  |g|= 0.0275  |ddm|= 0.133
  HOMO = -0.491434460176934  LUMO = 0.185460269060452
cycle= 4 E= -76.0267542098114  delta_E= -0.000193  |g|= 0.00607  |ddm|= 0.0186
  HOMO = -0.492819159191576  LUMO = 0.185569493922182
cycle= 5 E= -76.0267700586599  delta_E= -1.58e-05  |g|= 0.000817  |ddm|= 0.00726
  HOMO = -0.493073153554039  LUMO = 0.185477271405499
cycle= 6 E= -76.0267704078524  delta_E= -3.49e-07  |g|= 0.000142  |ddm|= 0.00121
  HOMO = -0.493112312236164  LUMO = 0.185476452649454
cycle= 7 E= -76.026770418929  delta_E= -1.11e-08  |g|= 1.35e-05  |ddm|= 0.000253
  HOMO = -0.493109420910091  LUMO = 0.185475807570053
cycle= 8 E= -76.0267704190365  delta_E= -1.08e-10  |g|= 3.39e-06  |ddm|= 2.34e-05
  HOMO = -0.493109151673819  LUMO = 0.185475732701394
Extra cycle  E= -76.026770419044  delta_E= -7.5e-12  |g|= 1.56e-06  |ddm|= 5.12e-06
converged SCF energy = -76.026770419044
 # Transforming hcore and eri to ortho AO basis.
 # Performing modified Cholesky decomposition on ERI tensor.
# Generating Cholesky decomposition of ERIs.
# max number of cholesky vectors = 240
# iteration     0: delta_max = 4.738268
# iteration     1: delta_max = 8.34319110e-01: time = 9.36433673e-04
# iteration     2: delta_max = 7.36822387e-01: time = 9.38439742e-04
# iteration     3: delta_max = 4.89056074e-01: time = 1.47356093e-03
# iteration     4: delta_max = 2.08320597e-01: time = 1.48801319e-03
# iteration     5: delta_max = 1.78614366e-01: time = 1.95005722e-03
# iteration     6: delta_max = 1.69891833e-01: time = 1.47046521e-03
# iteration     7: delta_max = 1.64229475e-01: time = 1.94834359e-03
# iteration     8: delta_max = 1.48889503e-01: time = 1.94931962e-03
# iteration     9: delta_max = 1.43336415e-01: time = 6.72340393e-04
# iteration    10: delta_max = 1.42965846e-01: time = 6.58428296e-04
# iteration    11: delta_max = 1.31443707e-01: time = 5.70876524e-04
# iteration    12: delta_max = 1.18344740e-01: time = 6.73847273e-04
# iteration    13: delta_max = 1.17948346e-01: time = 6.63956627e-04
# iteration    14: delta_max = 1.05717689e-01: time = 6.75542280e-04
# iteration    15: delta_max = 1.05442402e-01: time = 6.68363646e-04
# iteration    16: delta_max = 9.99118989e-02: time = 5.75672835e-04
# iteration    17: delta_max = 9.95205133e-02: time = 5.80938533e-04
# iteration    18: delta_max = 8.99361869e-02: time = 5.70645556e-04
# iteration    19: delta_max = 8.99094001e-02: time = 6.04454428e-04
# iteration    20: delta_max = 7.62904309e-02: time = 5.79161569e-04
# iteration    21: delta_max = 7.50722461e-02: time = 5.79474494e-04
# iteration    22: delta_max = 6.87261218e-02: time = 1.42931938e-03
# iteration    23: delta_max = 6.54324019e-02: time = 1.36526860e-03
# iteration    24: delta_max = 6.16431452e-02: time = 9.69264656e-04
# iteration    25: delta_max = 5.43173391e-02: time = 8.89208168e-04
# iteration    26: delta_max = 5.28587101e-02: time = 9.25980508e-04
# iteration    27: delta_max = 5.05280774e-02: time = 2.04846822e-03
# iteration    28: delta_max = 5.01957796e-02: time = 2.15568580e-03
# iteration    29: delta_max = 5.01123322e-02: time = 2.16846168e-03
# iteration    30: delta_max = 4.76309097e-02: time = 1.69058330e-03
# iteration    31: delta_max = 4.51085028e-02: time = 6.18238002e-04
# iteration    32: delta_max = 4.28565134e-02: time = 6.07736409e-04
# iteration    33: delta_max = 4.26800720e-02: time = 6.24312088e-04
# iteration    34: delta_max = 4.13748326e-02: time = 9.21206549e-04
# iteration    35: delta_max = 3.93536341e-02: time = 5.99544495e-04
# iteration    36: delta_max = 3.92081197e-02: time = 6.27400354e-04
# iteration    37: delta_max = 3.80921440e-02: time = 1.19296834e-03
# iteration    38: delta_max = 3.75496200e-02: time = 9.42634419e-04
# iteration    39: delta_max = 3.14273737e-02: time = 1.13445893e-03
# iteration    40: delta_max = 3.11180667e-02: time = 1.13228709e-03
# iteration    41: delta_max = 2.77629781e-02: time = 1.18394196e-03
# iteration    42: delta_max = 2.54846519e-02: time = 1.16493739e-03
# iteration    43: delta_max = 2.52057950e-02: time = 4.70470637e-04
# iteration    44: delta_max = 2.43261062e-02: time = 6.40047714e-04
# iteration    45: delta_max = 2.39692815e-02: time = 5.93475997e-04
# iteration    46: delta_max = 2.38893839e-02: time = 4.92112711e-04
# iteration    47: delta_max = 2.32440402e-02: time = 1.12165511e-03
# iteration    48: delta_max = 2.21809261e-02: time = 9.32700932e-04
# iteration    49: delta_max = 2.20971483e-02: time = 9.33893025e-04
# iteration    50: delta_max = 2.19183946e-02: time = 9.30177048e-04
# iteration    51: delta_max = 1.93467081e-02: time = 9.32630152e-04
# iteration    52: delta_max = 1.89755529e-02: time = 1.10528618e-03
# iteration    53: delta_max = 1.46665309e-02: time = 5.25068492e-04
# iteration    54: delta_max = 1.42505414e-02: time = 1.10951625e-03
# iteration    55: delta_max = 1.41759270e-02: time = 8.95742327e-04
# iteration    56: delta_max = 1.32700428e-02: time = 8.92708078e-04
# iteration    57: delta_max = 1.29105003e-02: time = 5.57092950e-04
# iteration    58: delta_max = 1.25700312e-02: time = 8.93451273e-04
# iteration    59: delta_max = 1.25237593e-02: time = 9.00371000e-04
# iteration    60: delta_max = 1.02684799e-02: time = 5.63466921e-04
# iteration    61: delta_max = 9.49526658e-03: time = 5.68350777e-04
# iteration    62: delta_max = 9.36212982e-03: time = 1.50042400e-03
# iteration    63: delta_max = 9.35639561e-03: time = 1.48452818e-03
# iteration    64: delta_max = 8.53152774e-03: time = 3.21162492e-03
# iteration    65: delta_max = 7.26967802e-03: time = 7.01541081e-04
# iteration    66: delta_max = 5.34111723e-03: time = 1.08556077e-03
# iteration    67: delta_max = 5.32544759e-03: time = 1.10729411e-03
# iteration    68: delta_max = 3.79599762e-03: time = 6.73217699e-04
# iteration    69: delta_max = 3.50947450e-03: time = 6.78682700e-04
# iteration    70: delta_max = 2.62822904e-03: time = 6.69106841e-04
# iteration    71: delta_max = 2.33922901e-03: time = 8.91285017e-04
# iteration    72: delta_max = 2.32543978e-03: time = 8.89746472e-04
# iteration    73: delta_max = 2.22486174e-03: time = 6.73724338e-04
# iteration    74: delta_max = 2.15100546e-03: time = 6.62488863e-04
# iteration    75: delta_max = 2.09778080e-03: time = 5.17129898e-04
# iteration    76: delta_max = 2.06792948e-03: time = 5.10532409e-04
# iteration    77: delta_max = 1.81337278e-03: time = 5.13439998e-04
# iteration    78: delta_max = 1.77498953e-03: time = 5.08585945e-04
# iteration    79: delta_max = 1.54488605e-03: time = 6.75823539e-04
# iteration    80: delta_max = 1.42066666e-03: time = 5.22263348e-04
# iteration    81: delta_max = 1.12843754e-03: time = 6.75573945e-04
# iteration    82: delta_max = 1.00207105e-03: time = 5.18636778e-04
# iteration    83: delta_max = 9.89330290e-04: time = 5.11324033e-04
# iteration    84: delta_max = 8.62387569e-04: time = 1.28201209e-03
# iteration    85: delta_max = 8.09756675e-04: time = 1.26772560e-03
# iteration    86: delta_max = 7.66924778e-04: time = 6.95550814e-04
# iteration    87: delta_max = 7.58583059e-04: time = 6.79505989e-04
# iteration    88: delta_max = 7.35099976e-04: time = 1.27292052e-03
# iteration    89: delta_max = 7.23978826e-04: time = 6.72010705e-04
# iteration    90: delta_max = 6.60492944e-04: time = 6.77417964e-04
# iteration    91: delta_max = 5.95082471e-04: time = 6.94956630e-04
# iteration    92: delta_max = 5.81617326e-04: time = 5.75916842e-04
# iteration    93: delta_max = 5.76422448e-04: time = 6.88603148e-04
# iteration    94: delta_max = 5.75312528e-04: time = 6.93237409e-04
# iteration    95: delta_max = 5.55924146e-04: time = 6.81368634e-04
# iteration    96: delta_max = 5.10080861e-04: time = 5.89909032e-04
# iteration    97: delta_max = 4.89693463e-04: time = 6.87951222e-04
# iteration    98: delta_max = 4.88124074e-04: time = 6.85844570e-04
# iteration    99: delta_max = 4.46617173e-04: time = 6.77850097e-04
# iteration   100: delta_max = 4.39953909e-04: time = 6.93049282e-04
# iteration   101: delta_max = 4.31865829e-04: time = 6.82458282e-04
# iteration   102: delta_max = 3.86742358e-04: time = 6.82698563e-04
# iteration   103: delta_max = 3.78372079e-04: time = 6.89756125e-04
# iteration   104: delta_max = 3.57420717e-04: time = 6.88191503e-04
# iteration   105: delta_max = 3.49221648e-04: time = 5.18327579e-04
# iteration   106: delta_max = 3.38826190e-04: time = 6.92974776e-04
# iteration   107: delta_max = 2.53642039e-04: time = 5.23947179e-04
# iteration   108: delta_max = 2.20604806e-04: time = 7.18170777e-04
# iteration   109: delta_max = 2.07488713e-04: time = 5.87081537e-04
# iteration   110: delta_max = 2.04774641e-04: time = 5.77371567e-04
# iteration   111: delta_max = 1.71528839e-04: time = 5.20506874e-04
# iteration   112: delta_max = 1.60367260e-04: time = 5.73784113e-04
# iteration   113: delta_max = 1.42050238e-04: time = 4.82156873e-04
# iteration   114: delta_max = 1.18583208e-04: time = 6.84389845e-04
# iteration   115: delta_max = 1.15251480e-04: time = 5.41845337e-04
# iteration   116: delta_max = 1.14519922e-04: time = 5.86811453e-04
# iteration   117: delta_max = 1.12267983e-04: time = 8.09229910e-04
# iteration   118: delta_max = 1.08466382e-04: time = 6.88476488e-04
# iteration   119: delta_max = 1.08102834e-04: time = 5.90747222e-04
# iteration   120: delta_max = 1.06394505e-04: time = 5.76805323e-04
# iteration   121: delta_max = 1.02533521e-04: time = 6.97417185e-04
# iteration   122: delta_max = 9.35180715e-05: time = 5.23800030e-04
# iteration   123: delta_max = 8.57150131e-05: time = 6.90782443e-04
# iteration   124: delta_max = 8.05736047e-05: time = 5.91738150e-04
# iteration   125: delta_max = 6.35984695e-05: time = 5.50756231e-04
# iteration   126: delta_max = 5.54712892e-05: time = 8.15112144e-04
# iteration   127: delta_max = 5.19448874e-05: time = 5.23196533e-04
# iteration   128: delta_max = 4.42819997e-05: time = 5.02286479e-04
# iteration   129: delta_max = 3.77100120e-05: time = 6.93643466e-04
# iteration   130: delta_max = 3.76959768e-05: time = 6.92186877e-04
# iteration   131: delta_max = 3.73054634e-05: time = 5.85347414e-04
# iteration   132: delta_max = 3.61192063e-05: time = 5.89428470e-04
# iteration   133: delta_max = 3.32021130e-05: time = 5.07270917e-04
# iteration   134: delta_max = 2.83399878e-05: time = 5.78947365e-04
# iteration   135: delta_max = 2.59306871e-05: time = 5.85615635e-04
# iteration   136: delta_max = 2.37304674e-05: time = 6.83618709e-04
# iteration   137: delta_max = 2.34706263e-05: time = 7.03686848e-04
# iteration   138: delta_max = 2.33779309e-05: time = 6.95716590e-04
# iteration   139: delta_max = 2.05163272e-05: time = 6.86669722e-04
# iteration   140: delta_max = 2.04267404e-05: time = 6.87843189e-04
# iteration   141: delta_max = 2.02487712e-05: time = 6.93999231e-04
# iteration   142: delta_max = 1.58964629e-05: time = 6.14412129e-04
# iteration   143: delta_max = 1.57423728e-05: time = 6.02947548e-04
# iteration   144: delta_max = 1.56185279e-05: time = 7.04284757e-04
# iteration   145: delta_max = 1.49099107e-05: time = 6.86319545e-04
# iteration   146: delta_max = 1.47606320e-05: time = 5.83687797e-04
# iteration   147: delta_max = 1.40464924e-05: time = 5.90683892e-04
# iteration   148: delta_max = 1.38497186e-05: time = 6.74560666e-04
# iteration   149: delta_max = 1.31859580e-05: time = 7.04551116e-04
# iteration   150: delta_max = 9.70494093e-06: time = 5.90194017e-04
 # Orthogonalising Cholesky vectors.
 # Time to orthogonalise: 0.001225
nelec: (5, 5)
nbasis: 24
chol.shape: (150, 576)

******** <class 'pyscf.cc.ccsd.CCSD'> ********
CC2 = 0
CCSD nocc = 5, nmo = 24
frozen orbitals 0
max_cycle = 50
direct = 0
conv_tol = 1e-07
conv_tol_normt = 1e-05
diis_space = 6
diis_start_cycle = 0
diis_start_energy_diff = 1e+09
max_memory 4000 MB (current use 90 MB)
    CPU time for CCSD integral transformation      0.01 sec, wall time      0.01 sec
Init t2, MP2 energy = -76.2307728881983  E_corr(MP2) -0.204002469154213
    CPU time for init mp2      0.00 sec, wall time      0.00 sec
Init E_corr(CCSD) = -0.204002469155255
cycle = 1  E_corr(CCSD) = -0.208953221515257  dE = -0.00495075236  norm(t1,t2) = 0.0215022
    CPU time for CCSD iter      0.01 sec, wall time      0.01 sec
cycle = 2  E_corr(CCSD) = -0.212157540872847  dE = -0.00320431936  norm(t1,t2) = 0.00747852
    CPU time for CCSD iter      0.01 sec, wall time      0.02 sec
cycle = 3  E_corr(CCSD) = -0.213212322069189  dE = -0.0010547812  norm(t1,t2) = 0.00283641
    CPU time for CCSD iter      0.01 sec, wall time      0.01 sec
cycle = 4  E_corr(CCSD) = -0.213346369625265  dE = -0.000134047556  norm(t1,t2) = 0.000524907
    CPU time for CCSD iter      0.01 sec, wall time      0.01 sec
cycle = 5  E_corr(CCSD) = -0.21332922457929  dE = 1.7145046e-05  norm(t1,t2) = 0.000178632
    CPU time for CCSD iter      0.01 sec, wall time      0.01 sec
cycle = 6  E_corr(CCSD) = -0.213325662124265  dE = 3.56245502e-06  norm(t1,t2) = 5.08503e-05
    CPU time for CCSD iter      0.01 sec, wall time      0.01 sec
cycle = 7  E_corr(CCSD) = -0.213327263105221  dE = -1.60098096e-06  norm(t1,t2) = 1.56914e-05
    CPU time for CCSD iter      0.01 sec, wall time      0.01 sec
cycle = 8  E_corr(CCSD) = -0.213326671218594  dE = 5.91886627e-07  norm(t1,t2) = 2.95894e-06
    CPU time for CCSD iter      0.01 sec, wall time      0.01 sec
cycle = 9  E_corr(CCSD) = -0.213326660466246  dE = 1.07523476e-08  norm(t1,t2) = 7.96844e-07
    CPU time for CCSD iter      0.01 sec, wall time      0.01 sec
    CPU time for CCSD      0.12 sec, wall time      0.14 sec
CCSD converged
E(CCSD) = -76.24009707951029  E_corr = -0.2133266604662463
    CPU time for CCSD integral transformation      0.01 sec, wall time      0.01 sec
max_memory 3906 MB (93 MB in use)
    CPU time for CCSD(T)      0.02 sec, wall time      0.02 sec
CCSD(T) correction = -0.00305853766015556
CCSD(T) energy -76.24315561717044
