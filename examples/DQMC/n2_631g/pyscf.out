#INFO: **** input file is /projects/anma2640/VMC/test/VMC/examples/DQMC/n2_631g/n2.py ****
import numpy
from pyscf import gto, scf, mcscf, fci, ao2mo, lib, tools, cc
from pauxy.utils.from_pyscf import generate_integrals
import scipy.linalg as la
import prepVMC

r = 2.
atomstring = f'N {-r/2} 0. 0.; N {r/2} 0. 0.;'
mol = gto.M(
    atom=atomstring,
    basis='6-31g',
    verbose=4,
    unit='bohr',
    symmetry=0,
    spin=0)
mf = scf.RHF(mol)
mf.kernel()
norb = mol.nao

h1 = mf.mo_coeff.T.dot(mf.get_hcore()).dot(mf.mo_coeff)
eri = ao2mo.kernel(mol, mf.mo_coeff)
print(f'eri.shape: {eri.shape}')
tools.fcidump.from_integrals('FCIDUMP_can', h1, eri, mol.nao, mol.nelectron, mf.energy_nuc())

# set up dqmc calculation
rhfCoeffs = numpy.eye(norb)
prepVMC.writeMat(rhfCoeffs, "rhf.txt")

h1e, chol, nelec, enuc = generate_integrals(mol, mf.get_hcore(), mf.mo_coeff, chol_cut=1e-5, verbose=True)

nbasis = h1e.shape[-1]
print(f'nelec: {nelec}')
print(f'nbasis: {nbasis}')
print(f'chol.shape: {chol.shape}')
chol = chol.reshape((-1, nbasis, nbasis))
v0 = 0.5 * numpy.einsum('nik,njk->ij', chol, chol, optimize='optimal')
h1e_mod = h1e - v0
chol = chol.reshape((chol.shape[0], -1))
prepVMC.write_dqmc(h1e, h1e_mod, chol, sum(mol.nelec), nbasis, enuc, filename='FCIDUMP_chol')

# ccsd
mycc = cc.CCSD(mf)
mycc.frozen = 0
mycc.verbose = 5
mycc.kernel()
prepVMC.write_ccsd(mycc.t1, mycc.t2)

et = mycc.ccsd_t()
print('CCSD(T) energy', mycc.e_tot + et)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='shas0136', release='3.10.0-957.21.3.el7.x86_64', version='#1 SMP Fri Jun 14 02:54:29 EDT 2019', machine='x86_64', processor='x86_64')  Threads 24
Python 3.8.3 (default, May 19 2020, 18:47:26) 
[GCC 7.3.0]
numpy 1.19.1  scipy 1.5.2
Date: Tue Apr 20 10:55:57 2021
PySCF version 1.7.4
PySCF path  /projects/anma2640/pyscf/pyscf
GIT HEAD      ref: refs/heads/master
GIT master branch  14142ec394cbdcffb8e214fba6b1d6cde9025e9a

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 2
[INPUT] num. electrons = 14
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry 0 subgroup None
[INPUT] Mole.unit = bohr
[INPUT]  1 N     -0.529177210920   0.000000000000   0.000000000000 AA   -1.000000000000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 N      0.529177210920   0.000000000000   0.000000000000 AA    1.000000000000   0.000000000000   0.000000000000 Bohr

nuclear repulsion = 24.5
number of shells = 10
number of NR pGTOs = 44
number of NR cGTOs = 18
basis = 6-31g
ecp = {}
CPU time:         0.83


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /scratch/summit/anma2640/tmpl495twea
max_memory 4000 MB (current use 79 MB)
Set gradient conv threshold to 3.16228e-05
init E= -109.126406354497
  HOMO = -0.389100690658942  LUMO = 0.0842078078821047
cycle= 1 E= -108.847743108022  delta_E= 0.279  |g|= 0.248  |ddm|= 1.86
  HOMO = -0.661474546142637  LUMO = 0.139950734372074
cycle= 2 E= -108.863752018053  delta_E= -0.016  |g|= 0.0536  |ddm|= 0.307
  HOMO = -0.627444702007831  LUMO = 0.175068336701997
cycle= 3 E= -108.864546939015  delta_E= -0.000795  |g|= 0.0115  |ddm|= 0.0803
  HOMO = -0.633085541791396  LUMO = 0.17231534199842
cycle= 4 E= -108.864599285846  delta_E= -5.23e-05  |g|= 0.000876  |ddm|= 0.0236
  HOMO = -0.63301150732863  LUMO = 0.172522461009854
cycle= 5 E= -108.86459960706  delta_E= -3.21e-07  |g|= 0.000114  |ddm|= 0.00137
  HOMO = -0.633008967888732  LUMO = 0.172555836962799
cycle= 6 E= -108.864599611705  delta_E= -4.64e-09  |g|= 9.96e-06  |ddm|= 0.000185
  HOMO = -0.633006759790394  LUMO = 0.172557454718311
cycle= 7 E= -108.864599611748  delta_E= -4.34e-11  |g|= 6.65e-07  |ddm|= 4.25e-05
  HOMO = -0.633006701829611  LUMO = 0.172557656511918
Extra cycle  E= -108.864599611748  delta_E= -1.99e-13  |g|= 1.62e-07  |ddm|= 1.07e-06
converged SCF energy = -108.864599611748
eri.shape: (171, 171)
 # Transforming hcore and eri to ortho AO basis.
 # Performing modified Cholesky decomposition on ERI tensor.
# Generating Cholesky decomposition of ERIs.
# max number of cholesky vectors = 180
# iteration     0: delta_max = 4.158222
# iteration     1: delta_max = 4.09809969e+00: time = 5.61170280e-04
# iteration     2: delta_max = 5.89592283e-01: time = 5.68289310e-04
# iteration     3: delta_max = 5.11398470e-01: time = 5.48342243e-04
# iteration     4: delta_max = 2.01896684e-01: time = 5.08746132e-04
# iteration     5: delta_max = 2.01896684e-01: time = 5.10742888e-04
# iteration     6: delta_max = 1.94821839e-01: time = 4.96612862e-04
# iteration     7: delta_max = 1.94821839e-01: time = 4.93047759e-04
# iteration     8: delta_max = 1.88490000e-01: time = 5.29233366e-04
# iteration     9: delta_max = 1.88377952e-01: time = 5.50020486e-04
# iteration    10: delta_max = 1.82756453e-01: time = 4.89836559e-04
# iteration    11: delta_max = 1.59269894e-01: time = 4.89057973e-04
# iteration    12: delta_max = 1.31720077e-01: time = 4.59969044e-04
# iteration    13: delta_max = 1.26564625e-01: time = 5.40982932e-04
# iteration    14: delta_max = 1.07720201e-01: time = 5.34947962e-04
# iteration    15: delta_max = 1.01456536e-01: time = 4.75883484e-04
# iteration    16: delta_max = 5.29321680e-02: time = 5.32131642e-04
# iteration    17: delta_max = 5.26330423e-02: time = 5.45259565e-04
# iteration    18: delta_max = 5.14936564e-02: time = 4.60362062e-04
# iteration    19: delta_max = 5.10135020e-02: time = 5.38891181e-04
# iteration    20: delta_max = 5.10135020e-02: time = 5.41333109e-04
# iteration    21: delta_max = 4.84309320e-02: time = 5.46788797e-04
# iteration    22: delta_max = 4.84309320e-02: time = 5.43247908e-04
# iteration    23: delta_max = 4.64269656e-02: time = 4.60723415e-04
# iteration    24: delta_max = 3.97566169e-02: time = 4.51723114e-04
# iteration    25: delta_max = 3.97566169e-02: time = 2.02295836e-02
# iteration    26: delta_max = 3.57865395e-02: time = 4.80631366e-04
# iteration    27: delta_max = 3.57221239e-02: time = 6.08960167e-04
# iteration    28: delta_max = 3.03564553e-02: time = 5.28132543e-04
# iteration    29: delta_max = 3.03564553e-02: time = 6.77632168e-04
# iteration    30: delta_max = 2.83098322e-02: time = 5.27296215e-04
# iteration    31: delta_max = 2.81508322e-02: time = 5.17705455e-04
# iteration    32: delta_max = 2.80364369e-02: time = 5.18999994e-04
# iteration    33: delta_max = 2.80364369e-02: time = 5.19368798e-04
# iteration    34: delta_max = 2.49551306e-02: time = 4.58013266e-04
# iteration    35: delta_max = 2.49551306e-02: time = 4.41564247e-04
# iteration    36: delta_max = 1.97645454e-02: time = 4.89380211e-04
# iteration    37: delta_max = 1.41999770e-02: time = 4.51996922e-04
# iteration    38: delta_max = 9.16084390e-03: time = 4.45870683e-04
# iteration    39: delta_max = 9.16084390e-03: time = 4.62336466e-04
# iteration    40: delta_max = 6.16835485e-03: time = 4.84684482e-04
# iteration    41: delta_max = 6.12387778e-03: time = 6.02491200e-04
# iteration    42: delta_max = 4.70401666e-03: time = 4.59179282e-04
# iteration    43: delta_max = 3.61347038e-03: time = 4.57303599e-04
# iteration    44: delta_max = 3.61347038e-03: time = 4.50162217e-04
# iteration    45: delta_max = 2.22288135e-03: time = 4.83267009e-04
# iteration    46: delta_max = 2.12531341e-03: time = 4.75702807e-04
# iteration    47: delta_max = 1.93387367e-03: time = 4.87655401e-04
# iteration    48: delta_max = 1.90639900e-03: time = 4.77558002e-04
# iteration    49: delta_max = 1.39427179e-03: time = 5.01506031e-04
# iteration    50: delta_max = 1.28603012e-03: time = 4.76507470e-04
# iteration    51: delta_max = 8.78587742e-04: time = 4.88290563e-04
# iteration    52: delta_max = 8.51684348e-04: time = 4.74752858e-04
# iteration    53: delta_max = 8.23977033e-04: time = 4.66629863e-04
# iteration    54: delta_max = 8.23977033e-04: time = 4.57750633e-04
# iteration    55: delta_max = 7.64026192e-04: time = 5.44372946e-04
# iteration    56: delta_max = 7.64026192e-04: time = 5.39900735e-04
# iteration    57: delta_max = 7.59405263e-04: time = 4.72286716e-04
# iteration    58: delta_max = 7.39427806e-04: time = 4.55383211e-04
# iteration    59: delta_max = 7.39427806e-04: time = 4.69144434e-04
# iteration    60: delta_max = 6.96361774e-04: time = 5.37740067e-04
# iteration    61: delta_max = 6.30718611e-04: time = 4.71921638e-04
# iteration    62: delta_max = 6.06290894e-04: time = 4.75892797e-04
# iteration    63: delta_max = 6.06290894e-04: time = 4.87521291e-04
# iteration    64: delta_max = 5.47513184e-04: time = 4.72387299e-04
# iteration    65: delta_max = 5.47513184e-04: time = 4.91760671e-04
# iteration    66: delta_max = 5.26651839e-04: time = 4.58430499e-04
# iteration    67: delta_max = 3.34436439e-04: time = 5.53039834e-04
# iteration    68: delta_max = 2.92882300e-04: time = 5.49886376e-04
# iteration    69: delta_max = 2.13691807e-04: time = 4.74834815e-04
# iteration    70: delta_max = 1.17294797e-04: time = 6.13572076e-04
# iteration    71: delta_max = 6.25210028e-05: time = 5.37186861e-04
# iteration    72: delta_max = 6.25210028e-05: time = 5.45257702e-04
# iteration    73: delta_max = 5.70702384e-05: time = 4.50750813e-04
# iteration    74: delta_max = 5.11078689e-05: time = 5.37328422e-04
# iteration    75: delta_max = 4.29038041e-05: time = 4.56048176e-04
# iteration    76: delta_max = 4.29012101e-05: time = 4.64396551e-04
# iteration    77: delta_max = 3.83885580e-05: time = 4.72893938e-04
# iteration    78: delta_max = 3.76219464e-05: time = 4.89592552e-04
# iteration    79: delta_max = 3.64598517e-05: time = 4.74503264e-04
# iteration    80: delta_max = 3.55948483e-05: time = 4.84118238e-04
# iteration    81: delta_max = 3.26187016e-05: time = 4.70776111e-04
# iteration    82: delta_max = 3.25977638e-05: time = 4.76952642e-04
# iteration    83: delta_max = 3.07516383e-05: time = 4.74544242e-04
# iteration    84: delta_max = 3.07516383e-05: time = 4.93530184e-04
# iteration    85: delta_max = 1.82093952e-05: time = 4.62209806e-04
# iteration    86: delta_max = 1.82093952e-05: time = 4.58385795e-04
# iteration    87: delta_max = 1.76357590e-05: time = 4.68946993e-04
# iteration    88: delta_max = 1.76357590e-05: time = 4.57735732e-04
# iteration    89: delta_max = 1.52012807e-05: time = 4.58205119e-04
# iteration    90: delta_max = 1.16800469e-05: time = 4.41733748e-04
# iteration    91: delta_max = 1.07570331e-05: time = 5.01822680e-04
# iteration    92: delta_max = 9.42363457e-06: time = 4.95901331e-04
 # Orthogonalising Cholesky vectors.
 # Time to orthogonalise: 0.000688
nelec: (7, 7)
nbasis: 18
chol.shape: (92, 324)

******** <class 'pyscf.cc.ccsd.CCSD'> ********
CC2 = 0
CCSD nocc = 7, nmo = 18
frozen orbitals 0
max_cycle = 50
direct = 0
conv_tol = 1e-07
conv_tol_normt = 1e-05
diis_space = 6
diis_start_cycle = 0
diis_start_energy_diff = 1e+09
max_memory 4000 MB (current use 88 MB)
    CPU time for CCSD integral transformation      0.09 sec, wall time      0.00 sec
Init t2, MP2 energy = -109.091124619402  E_corr(MP2) -0.226525007653379
    CPU time for init mp2      0.01 sec, wall time      0.00 sec
Init E_corr(CCSD) = -0.226525007653386
cycle = 1  E_corr(CCSD) = -0.208070368171545  dE = 0.0184546395  norm(t1,t2) = 0.0415772
    CPU time for CCSD iter      3.60 sec, wall time      0.19 sec
cycle = 2  E_corr(CCSD) = -0.217578075627961  dE = -0.00950770746  norm(t1,t2) = 0.0165414
    CPU time for CCSD iter      0.42 sec, wall time      0.02 sec
cycle = 3  E_corr(CCSD) = -0.217607411176544  dE = -2.93355486e-05  norm(t1,t2) = 0.00610812
    CPU time for CCSD iter      0.45 sec, wall time      0.04 sec
cycle = 4  E_corr(CCSD) = -0.219092938275197  dE = -0.0014855271  norm(t1,t2) = 0.0031132
    CPU time for CCSD iter      0.42 sec, wall time      0.02 sec
cycle = 5  E_corr(CCSD) = -0.219079458866225  dE = 1.3479409e-05  norm(t1,t2) = 0.000527012
    CPU time for CCSD iter      0.42 sec, wall time      0.02 sec
cycle = 6  E_corr(CCSD) = -0.219076874018208  dE = 2.58484802e-06  norm(t1,t2) = 6.882e-05
    CPU time for CCSD iter      0.42 sec, wall time      0.02 sec
cycle = 7  E_corr(CCSD) = -0.219079509103502  dE = -2.63508529e-06  norm(t1,t2) = 1.163e-05
    CPU time for CCSD iter      0.44 sec, wall time      0.02 sec
cycle = 8  E_corr(CCSD) = -0.219079457203277  dE = 5.19002244e-08  norm(t1,t2) = 3.35568e-06
    CPU time for CCSD iter      0.48 sec, wall time      0.04 sec
    CPU time for CCSD      6.65 sec, wall time      0.36 sec
CCSD converged
E(CCSD) = -109.0836790689516  E_corr = -0.2190794572032772
    CPU time for CCSD integral transformation      0.25 sec, wall time      0.01 sec
max_memory 3909 MB (90 MB in use)
    CPU time for CCSD(T)      0.40 sec, wall time      0.02 sec
CCSD(T) correction = -0.00670796860068505
CCSD(T) energy -109.09038703755226
